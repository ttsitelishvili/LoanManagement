# Loan Management API

ეს არის **RESTful Web API**, აგებული **.NET 8-ზე** **Clean Architecture** პრინციპების დაცვით. პროექტი უზრუნველყოფს სესხის განაცხადების მართვას, მომხმარებლების ავტორიზაციას და ბუღალტრის (ადმინისტრატორის) მიერ პროცესების კონტროლს.

---

##  პროექტის ფუნქციონალი

სისტემა დაყოფილია ორ ძირითად როლად: **User**  და **Accountant** .

###  User 

* **რეგისტრაცია და ავტორიზაცია:** სისტემაში შესვლა და პაროლის დაჰეშვა.
* **სესხის მოთხოვნა:** განაცხადის შევსება (თანხა, ვალუტა, პერიოდი).
* **სესხების ნახვა:** მხოლოდ საკუთარი განაცხადების დათვალიერება.
* **რედაქტირება/წაშლა:** საკუთარი განაცხადის შეცვლა ან გაუქმება შესაძლებელია მხოლოდ მაშინ, როცა სტატუსი არის **Processing**.

###  Accountant

* **მომხმარებლის დაბლოკვა:** შეუძლია შეზღუდოს მომხმარებლის მიერ სესხის აღების უფლება.
* **სტატუსის მართვა:** სესხის დამტკიცება (**Approved**) ან უარყოფა (**Rejected**).
* **სრული წვდომა:** ყველა მომხმარებლის ყველა სესხის ნახვა.
* **წაშლა:** ნებისმიერი სესხის წაშლა, სტატუსის მიუხედავად.

---

##  ტექნიკური მახასიათებლები

* **უსაფრთხოება:** **JWT (JSON Web Tokens)** ავტორიზაცია და **Role-Based Access Control (RBAC)**.
* **ვალიდაცია:** **FluentValidation-ის** გამოყენებით (მაგ: ასაკი $> 18$, ხელფასი $> 0$).
* **ლოგირება:** **Serilog-ის** გამოყენებით ფაილში იწერება სისტემური შეცდომები.
* **ტესტირება:** ბიზნეს ლოგიკა დაფარულია **Unit ტესტებით** (**xUnit & Moq**).

### გამოყენებული ტექნოლოგიები

* .NET 8 Web API
* PostgreSQL & Entity Framework Core (database)
* Clean Architecture (structure)
* JWT Bearer Authentication (security)
* Serilog (logging)
* FluentValidation (validation of data)
* xUnit & Moq (tests)

---

## გაშვების ინსტრუქცია (Setup)

მიჰყევით ამ ნაბიჯებს პროექტის გასაშვებად:
1.  დარწმუნდით, რომ დაინსტალირებული გაქვთ **PostgreSQL**.
2.  გახსენით `LoanManagement.API` პროექტში `appsettings.json` ფაილი და `ConnectionStrings` სექციაში მიუთითეთ თქვენი კონფიგურაცია:

    ```json
    "ConnectionStrings": {
      "DefaultConnection": "Host=localhost; Port=5432; Database=LoanManagementDb; Username=postgres;"
    }
    ```
      თუ საჭიროა, დაამატეთ `Password=თქვენი_პაროლი;`

გახსენით Visual Studio-ში **Package Manager Console** (დარწმუნდით, რომ Default Project არჩეულია `LoanManagement.Infrastructure`) და გაუშვით ბრძანება:

Update-Database -StartupProject LoanManagement.API

ეს ბრძანება შექმნის ბაზას და ცხრილებს (Users, Loans).
აპლიკაციის გასაშვებად, დააყენეთ LoanManagement.API როგორც Startup Project და გაუშვით (Run). ბრაუზერში გაიხსნება Swagger UI (https://localhost:7000/swagger).

##  API დოკუმენტაცია და გამოყენების წესები

აპლიკაციასთან სამუშაოდ გამოიყენეთ **Swagger** ინტერფეისი.

###  ავტორიზაცია

* **POST /api/Auth/register:** მომხმარებლის რეგისტრაცია.
    * *ვალიდაცია:* ასაკი $> 18$, ხელფასი $> 0$, მეილი ვალიდური.
* **POST /api/Auth/login:** სისტემაში შესვლა. აბრუნებს **JWT Token-ს**.

**როგორ გამოვიყენოთ ტოკენი:**
1.  დააკოპირეთ `login`-ის შედეგად მიღებული ტოკენი.
2.  Swagger-ში დააჭირეთ ღილაკს **Authorize**.
3.  ჩაწერეთ: `Bearer თქვენი_ტოკენი` და დააჭირეთ **Authorize**.

###  სესხები (Loan Controller)

*საჭიროებს ჩვეულებრივი მომხმარებლის ტოკენს.*

* **POST /api/Loan/apply:** ახალი სესხის მოთხოვნა. სტატუსი ავტომატურად ხდება **Processing**.
* **GET /api/Loan/my-loans:** აბრუნებს მხოლოდ ავტორიზებული მომხმარებლის სესხებს.
* **PUT /api/Loan/update/{id}:** სესხის რედაქტირება.
    * *შეზღუდვა:* მხოლოდ იმ შემთხვევაში, თუ სტატუსია **Processing**.
* **DELETE /api/Loan/delete/{id}:** სესხის წაშლა.
    * *შეზღუდვა:* მხოლოდ იმ შემთხვევაში, თუ სტატუსია **Processing**.

### ბუღალტერია (Accountant Controller)

*საჭიროებს მომხმარებელს, რომლის როლი არის **Accountant**.*

 **შენიშვნა:** ბუღალტრის შესაქმნელად, დაარეგისტრირეთ ჩვეულებრივი მომხმარებელი, შემდეგ შედით ბაზაში (`pgAdmin`) და `Users` ცხრილში ამ მომხმარებელს ხელით შეუცვალეთ `Role 0-დან 1-ზე`. შემდეგ თავიდან გაიარეთ ავტორიზაცია.

* **GET /api/Accountant/loans:** ყველა მომხმარებლის ყველა სესხის ნახვა.
* **POST /api/Accountant/block-user/{id}:** მომხმარებლის დაბლოკვა/განბლოკვა. დაბლოკილი მომხმარებელი სესხს ვერ ითხოვს.
* **PUT /api/Accountant/update-loan/{id}:** სესხის სტატუსის ცვლილება (**Approved** ან **Rejected**).
* **DELETE /api/Accountant/delete-loan/{id}:** ნებისმიერი სესხის წაშლა (შეზღუდვების გარეშე).
## არქიტექტურა

პროექტი აგებულია **Clean Architecture-ის** მიხედვით და დაყოფილია 4 დამოუკიდებელ პროექტად (ლეიერად):

1.  **`LoanManagement.Domain`** (Class Library):
    * შეიცავს ძირითად ობიექტებს (**Entity-ებს**: `User`, `Loan`) და **Enum-ებს**.
    * წარმოადგენს ბირთვს და **არ აქვს არანაირი დამოკიდებულება** (Dependency) სხვა პროექტებზე.

2.  **`LoanManagement.Application`** (Class Library):
    * შეიცავს **ბიზნეს ლოგიკას**, ინტერფეისებს (`ILoanService`, `IGenericRepository`), DTO-ებს და ვალიდატორებს.
    * დამოკიდებულია **მხოლოდ** Domain-ზე.

3.  **`LoanManagement.Infrastructure`** (Class Library):
    * პასუხისმგებელია **გარე დეტალებზე**, როგორიცაა მონაცემთა ბაზასთან კავშირი (`AppDbContext`, `GenericRepository`, Migrations).
    * ახდენს Application-ის ინტერფეისების **იმპლემენტაციას**.

4.  **`LoanManagement.API`** (Web API):
    * წარმოადგენს სისტემის **შესასვლელს** (Controllers).
    * აკავშირებს ყველა ლეიერს (**Dependency Injection**) და მართავს კონფიგურაციას.

##  ტესტირება

პროექტში ჩაშენებულია **Unit ტესტები** (`LoanManagement.Tests`), რომლებიც ამოწმებენ კრიტიკულ ბიზნეს ლოგიკას:

* დაბლოკილი მომხმარებლის მიერ სესხის მოთხოვნის აკრძალვა.
* უკვე დამუშავებული სესხის რედაქტირების აკრძალვა.
* ბუღალტრის მიერ სტატუსის ცვლილება.

ტესტების გასაშვებად Visual Studio-ში გამოიყენეთ: **Test > Run All Tests**.

